---
title: "Implicit spatial model to krill Dynamic Population in Antarctic Peninsula, 48-1 SubArea. SS3 aplications"
subtitle: "Working Paper to be submitted in CCAMLR WG-FSA 2024"
author:
  - Mardones Mauricio^[Universidad de Magallanes,Chile. mamardon@umag.cl]
  - César Cárdenas^[Instituto Antártico Chileno, Chile]
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::pdf_document2:
    number_sections: false
fig_caption: yes
bibliography: SA_krill.bib
csl: apa.csl
link-citations: yes
toc: false
linkcolor: blue
linestretch: 1.3
header-includes:
- \fontsize{12}{16}
- \selectfont
- \usepackage{lscape}
---
\newpage
\tableofcontents
\newpage


```{r setup1, echo=FALSE}
rm(list = ls())
knitr::opts_chunk$set(eval=FALSE,
                      echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center',
                      fig.pos = "H",
                      dev = 'jpeg',
                      dpi = 300,
                      tidy.opts=list(width.cutoff=50), 
                      tidy=TRUE)
#XQuartz is a mess, put this in your onload to default to cairo instead
options(bitmapType = "cairo") 
# (https://github.com/tidyverse/ggplot2/issues/2655)
# Lo mapas se hacen mas rapido
```

# ABSTRACT 



The stock assessment model for *Euphausia superba* (hereafter krill) in the Antarctic Peninsula, operating within a spatial-temporal and ecosystem framework, highlights the importance of incorporating spatial heterogeneity. The spatial heterogeneity, such as variations in oceanographic conditions and habitat suitability across different regions, is likely to outperform a population dynamics of krill. By accounting for spatial heterogeneity, a integrated stock assessment model can better capture localized dynamics and interactions, leading to more accurate predictions of krill population dynamics. This nuanced approach allows for a more refined understanding of different zones shape krill abundance, fishing mortality and recruitment patterns across the Antarctic Peninsula. Consequently, by acknowledging and integrating spatial heterogeneity, the stock assessment model can provide more robust insights into the ecological dynamics of krill populations and improve CCAMLR fishery management and conservation strategies in this region.

*Keywords: Krill populations, dynamic population, stock assessment, SS3, spatial implicit, management, CCAMLR.*



# INTRODUCTION

**(add refs)** 

Antarctica, with its pristine and unique ecosystems, hosts one of the most crucial marine resources, the Antarctic krill (Euphausia superba). These small crustaceans play a pivotal role in the Southern Ocean's food web, serving as a primary food source for a wide range of marine species, including whales, seals, and seabirds. Given its ecological significance and economic value, effective management of krill stocks is paramount to ensure the sustainability of Antarctic ecosystems and support fisheries-dependent communities.

In this context, the Commission for the Conservation of Antarctic Marine Living Resources (CCAMLR) plays a central role in the conservation and sustainable management of marine resources in the Southern Ocean. As part of its mandate, CCAMLR regularly conducts stock assessments to evaluate the status of key species, including Antarctic krill, and inform decision-making processes regarding fisheries management and conservation measures.

Traditionally, stock assessments have relied on single-source data, primarily from fisheries catch data or population monitoring surveys. However, these approaches may overlook critical aspects of krill ecology, such as spatial heterogeneity in abundance and distribution, as well as the influence of environmental factors and predator-prey interactions. Recognizing these limitations, there is a growing consensus on the need for integrated stock assessment models that incorporate multiple sources of information and consider the complex interplay of ecological variables.

In response to this need, we propose a comprehensive stock assessment of Antarctic krill in the Antarctic Peninsula, leveraging an integrated modeling approach. Unlike previous assessments, our model will integrate data from both fisheries and population monitoring efforts, providing a more holistic understanding of krill dynamics. Moreover, our approach will go beyond conventional methods by explicitly considering spatial heterogeneity in krill abundance and distribution across the Antarctic Peninsula.

Spatial heterogeneity is a fundamental aspect of krill ecology, driven by a myriad of factors including oceanographic conditions, sea ice dynamics, and predator foraging behavior. By incorporating spatially implicit information into our model, we aim to capture the complex spatial patterns of krill distribution and better understand the underlying drivers of variability in krill abundance. This spatially implicit approach will allow us to identify krill hotspots, areas of high productivity, and potential ecological corridors, providing valuable insights for conservation planning and management strategies.

Furthermore, our integrated model will take into account environmental variables known to influence krill abundance and distribution, such as sea surface temperature, chlorophyll concentration, and sea ice extent. These environmental factors play a critical role in shaping krill habitat suitability and productivity, thereby affecting their population dynamics. By integrating environmental data into our model, we aim to elucidate the relationships between environmental conditions and krill abundance, enabling more robust predictions of krill population dynamics under future climate scenarios.

Additionally, our model will consider predator-prey interactions as a key driver of krill population dynamics. Antarctic krill are a vital prey species for a wide range of predators, including whales, seals, and seabirds. Changes in predator populations and foraging behavior can have profound effects on krill abundance and distribution, with cascading impacts throughout the Antarctic ecosystem. By incorporating information on predator distribution, abundance, and feeding ecology, our model will provide a more comprehensive understanding of the trophic interactions shaping krill dynamics.


The methodology involves comparing the statistical performance of the model concerning spatial heterogeneity of krill. By comparing model outputs under scenarios where spatial heterogeneity is assumed versus not assumed, one can gauge the significance of incorporating spatial variation into the model. This methodology enables researchers to make informed decisions about the necessity of accounting for spatial heterogeneity in understanding krill distribution and abundance, thereby enhancing the accuracy and reliability of ecological modeling efforts.

In summary, our proposed stock assessment represents a novel and integrated approach to evaluating Antarctic krill populations in the Antarctic Peninsula. By leveraging multiple sources of information and explicitly considering spatial heterogeneity, environmental variables, and predator-prey interactions, our model aims to provide policymakers and stakeholders with actionable insights for informed decision-making within the framework of CCAMLR. Through collaborative efforts and interdisciplinary research, we are committed to advancing the science of krill ecology and supporting the conservation and sustainable management of Antarctic marine resources.


# METHODOLOGY

## Study Area in the Antarctic Peninsula

The study area for the assessment of krill populations in the Antarctic Peninsula is divided into strata to account for spatial heterogeneity. The Antarctic Peninsula region is vast and encompasses a variety of habitats and environmental conditions that can influence the distribution and abundance of krill. Therefore, dividing the study area into strata allows for a more detailed and accurate assessment of krill populations by considering local variations in environmental factors.

The strata in the Antarctic Peninsula may include different regions such as coastal areas, offshore waters, and areas influenced by major oceanographic features like currents and frontal systems. Each stratum may have distinct characteristics that affect krill biology, such as sea ice cover, water temperature, and nutrient availability (Figure \@ref(fig:mapa))

## Data Sources and Recolection

Stock Synthesis relies on multiple sources of data to inform the population dynamics model. These data sources may include:

1. **Fisheries Data:** Information on krill catches and fishing effort from commercial fisheries operating in the Antarctic Peninsula region.
  
2. **Population Monitoring Data:** Data collected from scientific research cruises and monitoring programs specifically designed to assess krill populations. This may include data on abundance, distribution, and biological characteristics of krill collected through net sampling, acoustic surveys, and other techniques.
  
3. **Environmental Data:** Environmental data such as sea surface temperature, chlorophyll concentration, and sea ice extent are also incorporated into the assessment. These data help to understand the influence of environmental factors on krill populations and their distribution.

4. **Predator information:** MAPPPD. Predator “fleet” to add like M2 in an integrated stock assessment, in this case, we use a index of penguins abundance to consider this like another kind of natural mortality.


In addition to existing data sources, researchers may submit requests to the Commission for the Conservation of Antarctic Marine Living Resources (CCAMLR) Secretariat for access to additional data relevant to krill population assessment. These requests may include data from scientific research programs, environmental monitoring initiatives, and other sources that can contribute to improving the accuracy and reliability of the assessment.

(Figure \@ref(fig:path))

## Conceptual Model 


The process of modeling and statistical analysis of a database can be structured according to the following guidelines:

- Contextualization of the problem. Definition of objectives and variables.
- Experiment design and data collection.
- Recording and preliminary processing of available information.
- Graphical inspection and trend identification.
- Consideration of distributional and relational hypotheses. Proposal of modeling.
- Model adjustment. Comparison and selection of the best model.
- Diagnosis and validation of the adjusted model.
- Assessment of the predictive capacity of the model and prediction.
- Interpretation and conclusions.

## Population Dynamics Model

In a simple way, the core of Stock Synthesis is its population dynamics model, which represents the dynamics of krill populations over time. This model incorporates key biological parameters such as growth rates, mortality rates, recruitment, and spawning biomass. The model is typically formulated using mathematical equations that describe how these parameters interact to determine the abundance and distribution of krill in the study area.

A typical state-space model for krill population dynamics can be represented as:

\[
N_t = N_{t-1} \cdot e^{(r - M)} + R
\]

Where:
- \(N_t\) is the abundance of krill at time \(t\).
- \(N_{t-1}\) is the abundance of krill at the previous time step.
- \(r\) is the intrinsic growth rate of the population.
- \(M\) is the mortality rate.
- \(R\) is the recruitment of new individuals into the population.

This equation represents the basic dynamics of the krill population, with abundance changing over time due to growth, mortality, and recruitment.

## Statistical model (SS3)

Stock Synthesis v.3.30.21 is a widely used software tool for assessing fish and invertebrate populations, including krill (Euphausia superba) in the Antarctic Peninsula region. The methodology employed by Stock Synthesis involves a comprehensive and integrated approach, utilizing various data sources and modeling techniques to estimate the main population variables of krill in WAP. 

The stock assesment model was configured using Stock Synthesis (SS3 hereafter)[SS3](https://vlab.noaa.gov/web/stock-synthesis) [@Methot2013; @methot2020stock] with the most updated version (V.3.30.21). SS3 is a structured age and size stock evaluation model, in the class of models called *"Integrated stock evaluation analysis model"*. SS3 has a stock population sub-model that simulates growth, maturity, fecundity, recruitment, movement, and mortality processes, and observation sub-models and expected values for different types of data. The model is coded in `C++` with estimation parameters enabled by automatic differentiation (ADMB) [@Fournier2012; @Methot2013]. The analysis of results and outputs uses R tools and the graphical interface of the *r4ss* library [@Taylor2019; @Winker2023].

By integrating data from multiple sources and considering spatial heterogeneity, the assessment methodology using Stock Synthesis v.3.30.21 provides a robust framework for evaluating the status of krill populations in the Antarctic Peninsula region. This information is essential for supporting management decisions aimed at ensuring the sustainable use of krill resources in this ecologically sensitive area.


## Scenarios

In Table 1 we have ten scenarios to test different option in modeling about main consideration in assessment of krill population.

| Scenario | Description                                      |
|:---------:|:-------------------------------------------------|
|    s01     | Fishery, Predator, Survey, Environmental data agreggate (Whole 48.1) |
|    s1     | Fishery data (Length, Index, Catch) by strata  and Predator and Env data      |
|    s2    | Fishery and Survey (AMLR) data Length, Index, Catch by strata and Predator and Env data |
|    s3     | Same "s2" Without S-R relation         |
|    s4     | Same "s2" Ricker S-R relation estimated          |
|    s5     | Same "s2" BH S-R relation weak (0.9 steepness)     |
|    s6     | Same "s2" BH S-R relation strong (0.6 steepness)     |
|    s7     | Same "s2" BH S-R relation mid-strong (0.65 steepness) estimated     |





```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, eval=TRUE}
# install.packages("devtools")
# devtools::install_github("r4ss/r4ss", ref="development")

# 
# install.packages("caTools")
# library("caTools")
# 
# install.packages("r4ss")
library(r4ss)
library(here)
#remotes::install_github("PIFSCstockassessments/ss3diags")
library(ss3diags)
library(kableExtra)
library(doParallel) # facilita la ejecución paralela en R
detectCores()
registerDoParallel(8)
library(ggpubr)
```


```{r fig.height=7}
SSplotData(base.model01, subplot = 1, 
           fleetnames = c("Fishery", "Survey", "Predator"),
           fleetcol = c("blue","green", "red"))

SSplotData(base.model2, 
           subplot = 1,
           pheight = 15)

```

Respecto a los valores y parametros biologicos modelados, los siguientes graficos identifican los estimadores puntuales del recurso

```{r}
SSplotSelex(base.model2,
            subplots = 1)
```


```{r eval=FALSE}
SSplotBiology(base.model2, 
              subplots =2, 
              labels = c("Length (cm)",
                         "Age (yr)",
                         "Maturity", 
                         "Mean weight (kg) in last year",
                          "Spawning output",
                         "Length (cm, beginning of the year)", 
                         "Natural mortality",
                          "Female weight (kg)", 
                         "Female length (cm)", 
                         "Fecundity", 
                         "Default fecundity label",
                          "Year", 
                         "Hermaphroditism transition rate", 
                         "Fraction females by age at equilibrium"),
 )

```

aporte de las cohortes por año para las capturas.
```{r eval=FALSE}
SSplotCohortCatch(base.model2, subplots = 1)
```

\quad

AJuste de tallas por flota
```{r eval=FALSE}
SSplotComps(base.model2, subplots = 1)
```

Otros plots
```{r}
SSplotDynamicB0(base.model2, uncertainty = F)
#SSplotSPR(base.model3)
```


```{r eval=FALSE}
SSplotPars(base.model2)

```

Salida de las biomasas con las dos flotas

```{r}
SSplotTimeseries(base.model01, subplot = 7)
```
Salida de las biomasas con todas las flotas

```{r}
SSplotTimeseries(base.model2, subplot = 7)
```

# RESULTS

## Diagnosis Base Model 

Step to do a good practice in model diagnosis is;

- 1. Convergence. Final convergence criteria is 1.0e-04

- 2. Residual (visual and metrics)

- 3. Retrospective analysis (Mhon Parameter)

- 4. Likelihood profile



## Residual

```{r eval=FALSE}
SSplotRunstest(base.model01, 
               subplots = "cpue",
               add=T)
SSplotRunstest(base.model2, 
               subplots = "len",
               add=T)
```


```{r}
SSplotJABBAres(base.model2,
               subplots = "cpue",
               add=T)
SSplotJABBAres(base.model2,
               subplots = "len",
               add=T)
```



## Predator fleet with RW

Random Walk (RW) refers to a mathematical model that describes a stochastic process in which a variable changes randomly over time, without a clear trend or pattern.

Specifically, a random walk can be used as a Bayesian estimation technique to infer the posterior distribution of an unknown parameter. In this approach, it is assumed that the prior distribution of the parameter is a normal distribution with mean zero and a known variance, and that the parameter value at each time step follows a random walk process. Based on the observed data and the prior distribution, the posterior distribution of the parameter can be calculated using Bayesian inference.

Random walk is a useful tool for parameter estimation in dynamic models, as it allows for modeling uncertainty and variability in the parameter's evolution over time. However, it is important to note that the random walk assumes that the changes in the parameter are random and without a clear trend, which may not be appropriate in all cases.

## Retrospective analysis

Los análisis retrospectivo, dan cuenta de diferencias de estimación (sub - sobreestimación) en los patrones entre modelos evaluados. 

```{r eval=FALSE}
retro(dir=dir7, oldsubdir="", 
      newsubdir="Retrospective", 
      years= 0:-5,
      exe="ss_osx",
      extras = "-nox", 
      skipfinished = F)
```


```{r echo=FALSE}
#s01
retroModels01 <- SSgetoutput(dirvec=file.path(dir01,
                                            "Retrospective",
                                            paste("retro",0:-5,
                                                  sep="")))

retroSummary01 <- SSsummarize(retroModels01)
# s1
retroModels1 <- SSgetoutput(dirvec=file.path(dir1,
                                            "Retrospective",
                                            paste("retro",0:-5,
                                                  sep="")))

retroSummary1 <- SSsummarize(retroModels1)
#s2
retroModels2 <- SSgetoutput(dirvec=file.path(dir2,
                                            "Retrospective",
                                            paste("retro",0:-5,
                                                  sep="")))

retroSummary2 <- SSsummarize(retroModels2)
#s3
retroModels3 <- SSgetoutput(dirvec=file.path(dir3,
                                            "Retrospective",
                                            paste("retro",0:-5,
                                                  sep="")))

retroSummary3 <- SSsummarize(retroModels3)
#s4
retroModels4 <- SSgetoutput(dirvec=file.path(dir4,
                                            "Retrospective",
                                            paste("retro",0:-5,
                                                  sep="")))

retroSummary4 <- SSsummarize(retroModels4)
#s5
retroModels5 <- SSgetoutput(dirvec=file.path(dir5,
                                            "Retrospective",
                                            paste("retro",0:-5,
                                                  sep="")))

retroSummary5 <- SSsummarize(retroModels5)
#s6
retroModels6 <- SSgetoutput(dirvec=file.path(dir6,
                                            "Retrospective",
                                            paste("retro",0:-5,
                                                  sep="")))

retroSummary6 <- SSsummarize(retroModels6)
#s7
retroModels7 <- SSgetoutput(dirvec=file.path(dir7,
                                            "Retrospective",
                                            paste("retro",0:-5,
                                                  sep="")))

retroSummary7 <- SSsummarize(retroModels7)

```


```{r echo FALSE}
#save(retroSummary, retroModels, file="retro5.Rdata")

retro01 <- SSplotRetro(retroSummary01,
            add=T,
            forecast = F,
            legend = T,
            verbose=F)
retro1 <- SSplotRetro(retroSummary1,
            add=T,
            forecast = F,
            legend = T,
            verbose=F)
retro2 <- SSplotRetro(retroSummary2,
            add=T,
            forecast = F,
            legend = T,
            verbose=F)
retro3 <- SSplotRetro(retroSummary3,
            add=T,
            forecast = F,
            legend = T,
            verbose=F)
retro4 <- SSplotRetro(retroSummary4,
            add=T,
            forecast = F,
            legend = T,
            verbose=F)
retro5 <- SSplotRetro(retroSummary5,
            add=T,
            forecast = F,
            legend = T,
            verbose=F)

retro6 <- SSplotRetro(retroSummary6,
            add=T,
            forecast = F,
            legend = T,
            verbose=F)


retro7 <- SSplotRetro(retroSummary7,
            add=T,
            forecast = F,
            legend = T,
            verbose=F)


```


```{r echo=FALSE}
ggarrange(retro01,
          retro1,
          retro2,
          retro3,
          retro4,
          retro5,
          retro6,
          retro7, ncol = 4, nrow = 4)
```


## Hindcast Cross-Validation and prediction skill

Implementing the Hindcast Cross-Validation (HCxval) diagnostic in Stock Synthesis requires the same model outputs generated by `r4ss:SS_doRetro()`. As a robust measure of prediction skill, we implemented the mean absolute scaled error (MASE). In brief, the MASE score scales the mean absolute. Regarding (A MASE score > 1 indicates that the average model forecasts are worse than a random walk. Conversely, a MASE score of 0.5 indicates that the model forecasts twice as
accurately as a naïve baseline prediction; thus, the model has prediction skill.



```{r}
hci = SSplotHCxval(retroSummary2, 
                   add = T, 
                   verbose = F, 
                   legendcex = 0.7)
```
## Kobe (status)

```{r}
mvln = SSdeltaMVLN(base.model01,
                   Fref = "MSY", 
                   plot = TRUE,
                   addprj=TRUE,
                   virgin = TRUE,
                   mc=100)

mvln = SSdeltaMVLN(base.model2,
                   Fref = "MSY", 
                   plot = TRUE,
                   addprj=TRUE,
                   virgin = TRUE,
                   mc=100)
```


```{r echo=FALSE}
# model01
tablebias01 <- SShcbias(retroSummary01,quant="SSB",verbose=F)
tablebias02 <- SShcbias(retroSummary01,quant="F",verbose=F)

kbl(tablebias01, booktabs = T,format = "latex",
    caption = "Rho parameter in SSB model s01")  %>% 
    kable_styling(latex_options = "HOLD_position")

kbl(tablebias02, booktabs = T,format = "latex",
    caption = "Rho parameter in F model s01")  %>% 
    kable_styling(latex_options = "HOLD_position")

# model2
tablebias7 <- SShcbias(retroSummary7,quant="SSB",verbose=F)
tablebias07 <- SShcbias(retroSummary7,quant="F",verbose=F)

kbl(tablebias7, booktabs = T,format = "latex",
    caption = "Rho parameter in SSB model s2")  %>% 
    kable_styling(latex_options = "HOLD_position")

kbl(tablebias7, booktabs = T,format = "latex",
    caption = "Rho parameter in F model s2")  %>% 
    kable_styling(latex_options = "HOLD_position")
```



## Verosimilitud


```{r eval=FALSE, echo = FALSE}
# 1. Identificar el directorio donde se encuentra el modelo base ----
dirname.model.run <- here("s2")
# 2. Crear un nuevo directorio para el "Perfil_Verosimilitud"  
dirname.R0.profile <- here("Ejercicios","Perfil_Verosimilitud")
dir.create(path=dirname.R0.profile, showWarnings = TRUE, recursive = TRUE)
# 3. Crear un subdirectorio llamado "plots_Verosimilitud" ----
plotdir=paste0(dirname.R0.profile, "/plots_Verosimilitud")
dir.create(path=plotdir, showWarnings = TRUE, recursive = TRUE)
# 4. Crear un subdirectorio llamado "simple" ----
reference.dir <- paste0(dirname.R0.profile,'/simple') 
dir.create(path=reference.dir, showWarnings = TRUE, recursive = TRUE)
# 5. Copiar el resultado del modelo base completo en este directorio ----
file.copy(Sys.glob(paste(dirname.model.run, "*.*", sep="/"),
                   dirmark = FALSE),
                    reference.dir)
# 6. Leer la salida del modelo base ----
Base <- SS_output(dir=reference.dir,covar=T)
# 7. Copiar los archivos necesarios de "simple" al directorio "Perfil_Verosimilitud" ----
copy_SS_inputs(dir.old = reference.dir, 
               dir.new =  dirname.R0.profile,
               copy_exe = TRUE,
               verbose = FALSE)
# 8. Leer los archivos del modelo ----
inputs <- r4ss::SS_read(dir = dirname.R0.profile)
# 9. Editar el archivo control la fase de estimación recdev ----
inputs$ctl$recdev_phase <- 1
# 10. Editar el archivo starter para leer los valores de inicio ----
inputs$start$init_values_src <- 0
# 11. Vector de valores para el perfil ----
R0.vec <- seq(15,20,0.5)  
Nprof.R0 <- length(R0.vec)
# 12. Cambiar el nombre del archivo control en el archivo starter.ss ----
inputs$start$ctlfile <- "control_modified.ss" 
# 13. Incluir prior_like para parámetros no estimados ----
inputs$start$prior_like <- 1                                 
# 14. Escribir los modelos modificados ----
r4ss::SS_write(inputs, dir = dirname.R0.profile, overwrite = TRUE)
# 15. Ejecutar la función profile() ----
?SS_profile()
profile <- profile(dir=dirname.R0.profile, # directory
                      exe="ss_osx",
                      oldctlfile ="control.ss",
                      newctlfile="control_modified.ss",
                      string="SR_LN(R0)",
                      profilevec=R0.vec)
# 16. Leer los archivos de salida ----
# (con nombres como Report1.sso, Report2.sso, etc.)
prof.R0.models <- SSgetoutput(dirvec=dirname.R0.profile, 
                              keyvec=1:Nprof.R0, 
                              getcovar = FALSE) 
# 17. Resumir las salidas con la función SSsummarize()  ----
prof.R0.summary <- SSsummarize(prof.R0.models)
# 18. Identificar los componentes de Verosimilitud ----
mainlike_components         <- c('TOTAL',
                                 "Survey", 
                                 'Length_comp',
                                 "Age_comp",
                                 'Size_at_age',
                                 'Recruitment') 
mainlike_components_labels  <- c('Total likelihood',
                                 'Index likelihood',
                                 'Length likelihood',
                                 "Age likelihood",
                                 'Size_at_age likelihood',
                                 'Recruitment likelihood') 
# 19. Funciones para generar plots de perfil de verosimilitud ----
### SSplotProfile() ----
png(file.path(plotdir,"R0_profile_plot.png"),
    width=7,
    height=4.5,
    res=300,
    units='in')
par(mar=c(5,4,1,1))
SSplotProfile(prof.R0.summary,           # summary object
              profile.string = "R0",     # substring of profile parameter
              profile.label=expression(log(italic(R)[0])), 
              ymax=150,minfraction = 0.001,
              pheight=4.5, 
              print=FALSE, 
              plotdir=plotdir, 
              components = mainlike_components, 
              component.labels = mainlike_components_labels,
              add_cutoff = TRUE,
              cutoff_prob = 0.95)

Baseval <- round(Base$parameters$Value[grep("R0",Base$parameters$Label)],2)
Baselab <- paste(Baseval,sep="")
axis(1,at=Baseval,label=Baselab)
abline(v = Baseval, lty=2)
dev.off()


### SSplotComparisons() ----
# Comparación de series de tiempo 
labs <- paste("SR_Ln(R0) = ",R0.vec)
labs[which(round(R0.vec,2)==Baseval)] <- paste("SR_Ln(R0) = ",
                                               Baseval,"(Base model)")

SSplotComparisons(prof.R0.summary,
                  legendlabels=labs,
                  pheight=4.5,png=TRUE,
                  plotdir=plotdir,
                  legendloc='bottomleft')

### PinerPlot() ----
#### R0_profile_plot_Length_like ----
png(file.path(plotdir,"R0_profile_plot_Length_like.png"),
    width=7,
    height=4.5,
    res=300,
    units='in')
par(mar=c(5,4,1,1))
PinerPlot(prof.R0.summary, 
          profile.string = "R0", 
          component = "Length_like",
          main = "Changes in length-composition likelihoods by fleet",
          add_cutoff = TRUE,
          cutoff_prob = 0.95)
Baseval <- round(Base$parameters$Value[grep("SR_LN",
                                      Base$parameters$Label)],2)
Baselab <- paste(Baseval,sep="")
axis(1,at=Baseval,
     label=Baselab)
abline(v = Baseval, lty=2)
dev.off()
#### R0_profile_plot_Survey_like ----
png(file.path(plotdir,"R0_profile_plot_Survey_like.png"),
    width=7,
    height=4.5,
    res=300,
    units='in')
par(mar=c(5,4,1,1))
PinerPlot(prof.R0.summary, 
          profile.string = "R0", 
          component = "Surv_like",
          main = "Changes in Index likelihoods by fleet",
          add_cutoff = TRUE,
          cutoff_prob = 0.95, legendloc="topleft")
Baseval <- round(Base$parameters$Value[grep("SR_LN",
                                            Base$parameters$Label)],2)
Baselab <- paste(Baseval,sep="")
axis(1,at=Baseval,label=Baselab)
abline(v = Baseval, lty=2)
dev.off()
```

## Comparision outputs betwwen scenarios

```{r echo=FALSE}
#PLOT labels, name of each model run
legend.labels <- c( "s01",
                  "s1",
                 "s2",
                 "s3",
                 "s4",
                 "s5",
                 "s6",
                 "s7")

#read in all model runs
#note if cover=T you need a hessian; if covar=F you do not need a hessian
biglist <- SSgetoutput(keyvec = NULL,
                       dirvec = c(dir01,
                                  dir1,
                                  dir2,
                                  dir3,
                                  dir4,
                                  dir5,
                                  dir6,
                                  dir7),
                       getcovar = F)

#create summary of model runs from list above
summaryoutput <- SSsummarize(biglist)

SSplotComparisons(summaryoutput,
                  legendlabels = c("s01",
                                   "s1",
                                   "s2",
                 "s3",
                 "s4",
                 "s5",
                 "s6",
                 "s7"),
                 labels = c("Year", 
                            "Spawning biomass (t)",
                            "Relative spawning biomass", 
                            "Age-0 recruits (1,000s)",
                            "Recruitment deviations", 
                            "Index", "Log index", 
                            "1 - SPR", 
                            "Density",
                            "Management target", 
                            "Minimum stock size threshold",
                            "Spawning output",
                            "Harvest rate"))

comp <- SSplotComparisons(summaryoutput,
                  legendlabels = c("s01",
                                   "s1",
                                   "s2",
                 "s3",
                 "s4",
                 "s5",
                 "s6",
                 "s7"),
                 subplots = c(2, 16))
comp
```


```{r}
comtable <- SStableComparisons(summaryoutput,
                   likenames = c("TOTAL", 
                                 "Survey", 
                                 "Length_comp",
                                 "Age_comp", 
                                 "priors",
                                 "Size_at_age"), 
                   names = c("Recr_Virgin",
                             "R0", 
                             "steep",
                             "NatM",
                             "L_at_Amax", 
                             "VonBert_K", 
                             "SSB_Virg", 
                             "Bratio_2017",
                             "SPRratio_2016"),
                   digits = NULL,
                   modelnames = c("s01", "s1","s2",
                 "s3",
                 "s4",
                 "s5",
                 "s6",
                 "s7"),
                   csv = FALSE,
                   csvdir =~"/DOCAS/SA_Krill",
                   csvfile = "parameter_comparison_table.csv",
                 verbose = TRUE,
                   mcmc = FALSE)
kbl(comtable, booktabs = T,format = "latex",
    caption = "Comparacion likelihood y parámetros s01, s1, s2, s3, s4, s5, s6 y s7")  %>% 
    kable_styling(latex_options = "scale_down")

```

\newpage
# DISCUSION

\newpage
# CONCLUSION

\newpage

# FIGURES AND TABLES

```{r mapa, out.width='100%', fig.cap="Subarea 48.1 and management strata considered in the spatio-temporal analysis of intrinsic productivity of Krill (BS=Brainsfield Strait, EI= Elephant Island, GERLASHE= Gerlashe strait, JOIN= Joinville Island, SSWI= South West)"}
knitr::include_graphics('Figs/481.png')
```
\begin{landscape}

```{r path, fig.cap="Framework path to stock assessment model in krill in WAP"}
knitr::include_graphics('Figs/pathmod.png')
```

Plot data 

```{r datas2, out.width='60%', fig.cap="Data series using in "s2" scenario"}
knitr::include_graphics('s2/plots/data_plot.png')
```

\end{landscape}


\newpage
# REFERENCES
